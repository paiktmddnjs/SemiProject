<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.spring.model.dao.ContractMapper">
    
    <!-- 계약 목록 조회 (회사 정보 JOIN) -->
    <select id="selectContractList" resultType="Contract">
        SELECT 
            c.CONTRACT_ID as contractId,
            c.CONTRACT_NAME as contractName,
            c.CONTRACT_STATUS as contractStatus,
            c.CONTRACT_FIX as contractFix,
            c.CONTRACT_START as contractStart,
            c.CONTRACT_END as contractEnd,
            c.CONTRACT_DESC as contractDesc,
            c.CONTRACT_AMOUNT as contractAmount,
            c.MEMBER_ID as memberId,
            c.COMPANY_ID as companyId,
            co.COMPANY_NAME as companyName,
            co.COMPANY_CALL as companyCall,
            co.COMPANY_MANAGER as companyManager,
            co.COMPANY_MANAGER_CALL as companyManagerCall,
            co.COMPANY_BUSINESS_CALL as companyBusinessCall,
            co.COMPANY_REPRESENTATIVE as companyRepresentative
        FROM CONTRACT c
        LEFT JOIN COMPANY co ON c.COMPANY_ID = co.COMPANY_ID
        ORDER BY c.CONTRACT_START DESC
    </select>
    
    <!-- 계약 상세 조회 -->
    <select id="selectContract" parameterType="int" resultType="Contract">
        SELECT 
            c.CONTRACT_ID as contractId,
            c.CONTRACT_NAME as contractName,
            c.CONTRACT_STATUS as contractStatus,
            c.CONTRACT_FIX as contractFix,
            c.CONTRACT_START as contractStart,
            c.CONTRACT_END as contractEnd,
            c.CONTRACT_DESC as contractDesc,
            c.CONTRACT_AMOUNT as contractAmount,
            c.MEMBER_ID as memberId,
            c.COMPANY_ID as companyId,
            co.COMPANY_NAME as companyName,
            co.COMPANY_CALL as companyCall,
            co.COMPANY_MANAGER as companyManager,
            co.COMPANY_MANAGER_CALL as companyManagerCall,
            co.COMPANY_BUSINESS_CALL as companyBusinessCall,
            co.COMPANY_REPRESENTATIVE as companyRepresentative
        FROM CONTRACT c
        LEFT JOIN COMPANY co ON c.COMPANY_ID = co.COMPANY_ID
        WHERE c.CONTRACT_ID = #{contractId}
    </select>
    
    <!-- 계약 통계 조회 -->
    <select id="selectContractSummary" resultType="ContractSummary">
        SELECT 
            (SELECT COUNT(*) FROM CONTRACT WHERE CONTRACT_STATUS = 'Y') as activeContracts,
            (SELECT NVL(SUM(CONTRACT_AMOUNT), 0) FROM CONTRACT) as totalAmount,
            (SELECT COUNT(*) FROM CONTRACT 
             WHERE TO_CHAR(CONTRACT_START, 'YYYY-MM') = TO_CHAR(SYSDATE, 'YYYY-MM')) as newContractsThisMonth,
            0 as newContractsGrowthRate,
            (SELECT COUNT(*) FROM CONTRACT WHERE CONTRACT_STATUS != 'Y') as pendingPayments
        FROM DUAL
    </select>
    
    <!-- 계약 추가 -->
    <insert id="insertContract" parameterType="Contract">
        INSERT INTO CONTRACT (
            CONTRACT_ID,
            CONTRACT_NAME,
            CONTRACT_STATUS,
            CONTRACT_FIX,
            CONTRACT_START,
            CONTRACT_END,
            CONTRACT_DESC,
            CONTRACT_AMOUNT,
            MEMBER_ID,
            COMPANY_ID
        ) VALUES (
            SEQ_CONTRACT_ID.NEXTVAL,
            #{contractName},
            #{contractStatus},
            #{contractFix},
            #{contractStart},
            #{contractEnd},
            #{contractDesc},
            #{contractAmount},
            #{memberId},
            #{companyId}
        )
    </insert>
    
    <!-- 계약 수정 -->
    <update id="updateContract" parameterType="Contract">
        UPDATE CONTRACT SET
            CONTRACT_NAME = #{contractName},
            CONTRACT_STATUS = #{contractStatus},
            CONTRACT_FIX = #{contractFix},
            CONTRACT_START = #{contractStart},
            CONTRACT_END = #{contractEnd},
            CONTRACT_DESC = #{contractDesc},
            CONTRACT_AMOUNT = #{contractAmount},
            COMPANY_ID = #{companyId}
        WHERE CONTRACT_ID = #{contractId}
    </update>
    
    <!-- 계약 삭제 -->
    <delete id="deleteContract" parameterType="int">
        DELETE FROM CONTRACT WHERE CONTRACT_ID = #{contractId}
    </delete>
    
    <!-- 회사 목록 조회 -->
    <select id="selectCompanyList" resultType="Company">
        SELECT 
            COMPANY_ID as companyId,
            COMPANY_NAME as companyName,
            COMPANY_CALL as companyCall,
            COMPANY_MANAGER as companyManager,
            COMPANY_MANAGER_CALL as companyManagerCall,
            COMPANY_BUSINESS_CALL as companyBusinessCall,
            COMPANY_REPRESENTATIVE as companyRepresentative
        FROM COMPANY
        ORDER BY COMPANY_NAME
    </select>
    
    <!-- 회사 추가 -->
    <insert id="insertCompany" parameterType="Company">
        INSERT INTO COMPANY (
            COMPANY_ID,
            COMPANY_NAME,
            COMPANY_CALL,
            COMPANY_MANAGER,
            COMPANY_MANAGER_CALL,
            COMPANY_BUSINESS_CALL,
            COMPANY_REPRESENTATIVE
        ) VALUES (
            SEQ_COMPANY_ID.NEXTVAL,
            #{companyName},
            #{companyCall},
            #{companyManager},
            #{companyManagerCall},
            #{companyBusinessCall},
            #{companyRepresentative}
        )
    </insert>
    
</mapper>

